<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2017-05-07 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20170507" />
    <meta http-equiv="Content-Language" content="en" />
    <title>JDBDT &#x2013; Database setup</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="./" id="bannerLeft">
                                                                                                <img src="images/jdbdt-logo.png"  alt="JDBDT"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 2017-05-07
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.10
                      </li>
                      
              
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">JDBDT</li>
                              
      <li>
  
                          <a href="index.html" title="Home">
          <span class="none"></span>
        Home</a>
            </li>
                
      <li>
  
                          <a href="http://www.eclipse.org/legal/epl-v10.html" class="externalLink" title="License">
          <span class="none"></span>
        License</a>
            </li>
                              <li class="nav-header">Reference</li>
                              
      <li>
  
                          <a href="Facade.html" title="API facade">
          <span class="none"></span>
        API facade</a>
            </li>
                
      <li>
  
                          <a href="DB.html" title="Database handles">
          <span class="none"></span>
        Database handles</a>
            </li>
                
      <li>
  
                          <a href="DataSources.html" title="Data sources">
          <span class="none"></span>
        Data sources</a>
            </li>
                
      <li>
  
                          <a href="DataSets.html" title="Data sets">
          <span class="none"></span>
        Data sets</a>
            </li>
                
      <li class="active">
  
            <a href="#"><span class="none"></span>Database setup</a>
          </li>
                
      <li>
  
                          <a href="DBAssertions.html" title="Assertions">
          <span class="none"></span>
        Assertions</a>
            </li>
                
      <li>
  
                          <a href="Logs.html" title="Logging format">
          <span class="none"></span>
        Logging format</a>
            </li>
                
      <li>
  
                          <a href="Compatibility.html" title="Compatibility">
          <span class="none"></span>
        Compatibility</a>
            </li>
                
      <li>
  
                          <a href="apidocs/index.html" title="Javadoc">
          <span class="none"></span>
        Javadoc</a>
            </li>
                              <li class="nav-header">Tutorial</li>
                              
      <li>
  
                          <a href="Tutorial.html" title="Guide">
          <span class="none"></span>
        Guide</a>
            </li>
                
      <li>
  
                          <a href="http://github.com/edrdo/jdbdt-tutorial" class="externalLink" title="Code @ GitHub">
          <span class="none"></span>
        Code @ GitHub</a>
            </li>
                              <li class="nav-header">Development</li>
                              
      <li>
  
                          <a href="http://search.maven.org/#search%7Cga%7C1%7Cjdbdt" class="externalLink" title="Maven Central">
          <span class="none"></span>
        Maven Central</a>
            </li>
                
      <li>
  
                          <a href="https://github.com/edrdo/jdbdt/" class="externalLink" title="Source code">
          <span class="none"></span>
        Source code</a>
            </li>
                
      <li>
  
                          <a href="https://github.com/edrdo/jdbdt/issues/" class="externalLink" title="Issue tracker">
          <span class="none"></span>
        Issue tracker</a>
            </li>
                
      <li>
  
                          <a href="https://travis-ci.org/edrdo/jdbdt/" class="externalLink" title="Continuous integration">
          <span class="none"></span>
        Continuous integration</a>
            </li>
                
      <li>
  
                          <a href="https://sonarqube.com/dashboard?id=org.jdbdt%3Ajdbdt" class="externalLink" title="SonarQube">
          <span class="none"></span>
        SonarQube</a>
            </li>
                
      <li>
  
                          <a href="Inception.html" title="Inception">
          <span class="none"></span>
        Inception</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Database setup</h1>
<p>The contents of a database may be defined using setup methods in the <tt>JDBDT</tt> facade. The functionality at stake comprises <a href="DBSetup.html#Insert">inserting data / populating tables</a>, <a href="DBSetup.html#Clean">cleaning up data from tables</a>, and <a href="DBSetup.html#SaveAndRestore">setting and restoring a save-point</a>. A number of <a href="DBSetup.html#Patterns">database setup patterns</a> can be implemented using these operations.</p>
<div class="section">
<h2><a name="Inserting_data"></a>Inserting data</h2>
<p><a name="Insert"></a></p>
<p>Database data may be inserted using one of the following methods:</p>

<ol style="list-style-type: decimal">
  
<li><tt>insert(data)</tt> inserts <tt>data</tt> (a <a href="DataSets.html">data set</a>) into the <a href="DataSources.html">table</a> given by <tt>data.getSource()</tt>.</li>
  
<li><tt>populate(data)</tt> inserts <tt>data</tt> like <tt>insert</tt>, but clears the table first using a DELETE statement, and also records <tt>data</tt> as the <a href="DBAssertions.html#Snapshots">snapshot for subsequent delta assertions</a>.</li>
</ol>
<p>Thus, <tt>insert</tt> should be used for incremental additions to a table, whereas <tt>populate</tt> should be used to reset the contents of a table contents entirely. The use of <tt>populate</tt> is more adequate in particular if <a href="DBAssertions.html">delta assertions</a> are performed over the table subsequently.</p>
<p><i>Illustration</i></p>

<div class="source">
<div class="source"><pre class="prettyprint">import static org.jdbdt.JDBDT.*;
import org.jdbdt.DB;
import org.jdbdt.Table;
import org.jdbdt.DataSet;
import java.sql.Date;
...
DB db = ...;
Table t = ...   

// Create a data set for t.
DataSet data = 
   builder(t)
  . ...
  .data();
...

// 1. Reset contents of USER to data.
populate(data); 
...

// 2. OR insert data in USER table (does not clear previous contents).
insert(data);
</pre></div></div>
<p>The <tt>populateIfChanged</tt> method is a variant of <tt>populate</tt> that executes conditionally, i.e., if the table contents are seen as unchanged,no operation takes place. This only happens if an <tt>assertUnchanged</tt> <a href="DBAssertions.html">assertion</a> previously succeeded, and no intervening subsequent JDBDT setup or assertion methods were called for the table. </p>
<p>More generally, you may query the changed status of data sources using the <tt>changed</tt> facade method, and use it to guide database setup if convenient.</p></div>
<div class="section">
<h2><a name="Cleaning_data"></a>Cleaning data</h2>
<p><a name="Clean"></a></p>
<p>Database data may be cleaned up using one of the following methods:</p>

<ol style="list-style-type: decimal">
  
<li><tt>deleteAll(t)</tt> clears the entire contents of table <tt>t</tt> using a DELETE statement without an associated WHERE clause.</li>
  
<li><tt>deleteAllWhere(t, where, [,args])</tt> clears the contents of <tt>t</tt> using a DELETE statement with a WHERE clause <tt>where</tt> and optional WHERE clause arguments <tt>args</tt>.</li>
  
<li><tt>truncate(t)</tt> clears <tt>t</tt> using a TRUNCATE TABLE statement.</li>
</ol>
<p>Note that <tt>truncate</tt> may be faster than <tt>deleteAll</tt>, but the associated TRUNCATE TABLE statement may not respect integrity constraints and has variable semantics for different database engines (e.g., <a class="externalLink" href="https://en.wikipedia.org/wiki/Truncate_(SQL)">see here</a>). Some engines do not support table truncation altogether (for instance SQLite).</p>
<p><i>Illustration</i></p>

<div class="source">
<div class="source"><pre class="prettyprint">import static org.jdbdt.JDBDT.*;
import org.jdbdt.DB;
import org.jdbdt.Table;
...
DB db = ...;
Table t = table(&quot;USERS&quot;)
         .columns(&quot;ID&quot;, &quot;LOGIN&quot;, &quot;NAME&quot;, &quot;PASSWORD&quot;, &quot;CREATED&quot;)
         .build(db);
...
// 1. Clear table using a DELETE statement.
deleteAll(t);

// 2. Delete all users whose login matches a certain filter
String loginFilter = ...;
deleteAll(t, &quot;LOGIN LIKE ?&quot;, loginFilter);

// 3. Clear table using TRUNCATE.
truncate(t);
</pre></div></div></div>
<div class="section">
<h2><a name="Save_and_restore"></a>Save and restore</h2>
<p><a name="SaveAndRestore"></a></p>
<p>Database state may be saved and restored as follows per <a href="DB.html">database handle</a> <tt>db</tt>:</p>

<ol style="list-style-type: decimal">
  
<li>A call to <tt>save(db)</tt> sets a database save-point. Internally, the save-point is set <tt>java.sql.Connection.setSavepoint()</tt> for the underlying database connection, which must have auto-commit disabled.</li>
  
<li>A call to <tt>restore(db)</tt> restores (rolls back) the database state to the JDBDT save-point defined using the last call to <tt>save(db)</tt>, as long as there were no intervening database commits.</li>
</ol>
<p>Note that that an unique one save-point is maintained per database handle, and that there should be exactly one <tt>restore</tt> call per each <tt>save</tt> call. These constraints try to ensure portable behavior across database engines.</p>
<p>In relation to <tt>save</tt> and <tt>restore</tt>, <tt>commit(db)</tt> is a shorthand for <tt>db.getConnection().commit()</tt>. Such a call commits all database changes and discards the JDBDT save-point (or any other save-point set for the database otherwise).</p>
<p><i>Illustration</i></p>

<div class="source">
<div class="source"><pre class="prettyprint">import static org.jdbdt.JDBDT.*;
import java.sql.Connection;
import org.jdbdt.DB;
...
// Database handle ...
DB db = database(...);
// Disable auto-commit
db.getConnection().setAutoCommit(false);

// Set save-point
save(db);

// Exercise the SUT, then execute some assertions  
letTheSUTWork();
assertXXX();

// Restore database state
restore(db);
</pre></div></div></div>
<div class="section">
<h2><a name="Database_setup_patterns"></a>Database setup patterns</h2>
<p>A number of database test patterns can be implemented using JDBDT, as exemplified in the <a href="Tutorial.html">JDBDT tutorial</a>. The code skeleton below (assuming <a class="externalLink" href="http://junit.org">JUnit</a>-based tests) illustrates the implementation of two patterns described in <a class="externalLink" href="http://xunitpatterns.com">xunitpatterns.com</a>:</p>

<ol style="list-style-type: decimal">
  
<li><a class="externalLink" href="http://xunitpatterns.com/Transaction%20Rollback%20Teardown.html">Transaction Rollback Teardown</a>: changes to the database are rolled back at the end of each test, back to an initial configuration. In the illustration below, the reference database state is set once in <tt>oneTimeSetup</tt> (annotated with <tt>@BeforeClass</tt>). This state is respectively saved and restored, before and after each test executes, in <tt>setSavePoint</tt> (annotated with <tt>@Before</tt>) and <tt>restoreSavePoint</tt> (annotated with <tt>@After</tt>).</li>
  
<li><a class="externalLink" href="http://xunitpatterns.com/Table%20Truncation%20Teardown.html">Table Truncation Teardown</a>: clean up each table on tear-down after conducting tests, as shown for <tt>oneTimeTeardown</tt> (annotated with <tt>@AfterClass</tt>).</li>
</ol>
<p><i>Illustration</i> </p>

<div class="source">
<div class="source"><pre class="prettyprint">import java.sql.Connection;
import org.junit.BeforeClass;
import org.junit.AfterClass;
import org.junit.Before;
import org.junit.After;
import org.junit.Test;

import static org.jdbdt.JDBDT.*;
import org.jdbdt.DB;
import org.jdbdt.DataSet;
import org.jdbdt.Table;

public class MyTest {

  static DB myDB;
  static Table myTable1, myTable2, ... ;

  @BeforeClass 
  public static void oneTimeSetup() {
    ...
    // Setup database handle
    myDB = database( ... );

    // Define tables and corresponding initial data
    myTable1 = table(...) ... 
    DataSet initialData1 = data(myTable1). ... ;
    populate(initialData1);

    // etc for myTable2 ...
    myTable2 = table(...) ...;
    ...

    // Ensure that auto-commit is off
    myDB.getConnection().setAutoCommit(false);
  }

  @AferClass
  public void oneTimeTeardown() {
    // Alternatively use deleteAll ...
    truncate(myTable1);
    truncate(myTable2);
    ...
    teardown(myDB, true); // free resources and close DB connection 
  }

  @Before
  public void setSavePoint() {
    save(myDB);
  }

  @After
  public void restoreSavePoint() {
    restore(myDB);
  }

  @Test 
  public void test1() {
    // Specific setup for test
    ...
    // Exercise the SUT, perform assertions
    ...
  }

  @Test 
  public void test2() { ... etc ... } 
  ...
</pre></div></div></div>
<div class="section">
<h2><a name="Summary_of_methods"></a>Summary of methods</h2>
<p><a name="MethodReference"></a></p>
<div class="section">
<h3><a name="JDBDT"></a><tt>JDBDT</tt></h3>
<p>Insertion:</p>

<ul>
  
<li><tt>insert(data)</tt> inserts <tt>data</tt> into a table (the table is <tt>data.getSource()</tt>).</li>
  
<li><tt>populate(data)</tt> sets <tt>data</tt> as the contents of a table (the table is <tt>data.getSource()</tt>).</li>
  
<li><tt>populateIfChanged(data)</tt> sets <tt>data</tt> as the contents of a table, if the table is perceived as having changed.</li>
</ul>
<p>Clean-up:</p>

<ul>
  
<li><tt>delete(t)</tt> clear table <tt>t</tt> with a DELETE statement.</li>
  
<li><tt>deleteAll(t,w,a)</tt> deletes data from table <tt>t</tt> subject to WHERE clause <tt>w</tt> and optional WHERE clause arguments.</li>
  
<li><tt>truncate(t)</tt> clear table <tt>t</tt> with a TRUNCATE TABLE statement.</li>
</ul>
<p>Save and restore:</p>

<ul>
  
<li><tt>save(db)</tt> sets the JDBDT save-point;</li>
  
<li><tt>restore(db)</tt> restores database state back to the JDBDT save-point;</li>
  
<li><tt>commit(db)</tt> performs a database commit, discarding the JDBDT save-point (or any other save-point set);</li>
</ul></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2016&#x2013;2017
                        <a href="http://jdbdt.org">JDBDT</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
