<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-03-14 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180314" />
    <meta http-equiv="Content-Language" content="en" />
    <title>JDBDT &#x2013; Database setup</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="./" id="bannerLeft">
                                                                                                <img src="images/jdbdt-logo.png"  alt="JDBDT"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 2018-03-14
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 1.0.6
                      </li>
                      
              
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">JDBDT</li>
                              
      <li>
  
                          <a href="index.html" title="Home">
          <span class="none"></span>
        Home</a>
            </li>
                
      <li>
  
                          <a href="MIT_License.html" title="License">
          <span class="none"></span>
        License</a>
            </li>
                              <li class="nav-header">Reference</li>
                              
      <li>
  
                          <a href="Facade.html" title="API facade">
          <span class="none"></span>
        API facade</a>
            </li>
                
      <li>
  
                          <a href="DB.html" title="Database handles">
          <span class="none"></span>
        Database handles</a>
            </li>
                
      <li>
  
                          <a href="DataSources.html" title="Data sources">
          <span class="none"></span>
        Data sources</a>
            </li>
                
      <li>
  
                          <a href="DataSets.html" title="Data sets">
          <span class="none"></span>
        Data sets</a>
            </li>
                
      <li class="active">
  
            <a href="#"><span class="none"></span>Database setup</a>
          </li>
                
      <li>
  
                          <a href="DBAssertions.html" title="Assertions">
          <span class="none"></span>
        Assertions</a>
            </li>
                
      <li>
  
                          <a href="Logs.html" title="Logging format">
          <span class="none"></span>
        Logging format</a>
            </li>
                
      <li>
  
                          <a href="Compatibility.html" title="Compatibility">
          <span class="none"></span>
        Compatibility</a>
            </li>
                
      <li>
  
                          <a href="apidocs/index.html" title="Javadoc">
          <span class="none"></span>
        Javadoc</a>
            </li>
                              <li class="nav-header">Tutorial</li>
                              
      <li>
  
                          <a href="Tutorial.html" title="Guide">
          <span class="none"></span>
        Guide</a>
            </li>
                
      <li>
  
                          <a href="http://github.com/JDBDT/jdbdt-tutorial" class="externalLink" title="Code @ GitHub">
          <span class="none"></span>
        Code @ GitHub</a>
            </li>
                              <li class="nav-header">Development</li>
                              
      <li>
  
                          <a href="http://search.maven.org/#search%7Cga%7C1%7Cjdbdt" class="externalLink" title="Maven Central">
          <span class="none"></span>
        Maven Central</a>
            </li>
                
      <li>
  
                          <a href="https://github.com/JDBDT/jdbdt/" class="externalLink" title="Source code">
          <span class="none"></span>
        Source code</a>
            </li>
                
      <li>
  
                          <a href="https://github.com/JDBDT/jdbdt/issues/" class="externalLink" title="Issue tracker">
          <span class="none"></span>
        Issue tracker</a>
            </li>
                
      <li>
  
                          <a href="https://travis-ci.org/JDBDT/jdbdt/" class="externalLink" title="Travis CI">
          <span class="none"></span>
        Travis CI</a>
            </li>
                
      <li>
  
                          <a href="https://ci.appveyor.com/project/edrdo/jdbdt" class="externalLink" title="AppVeyor CI">
          <span class="none"></span>
        AppVeyor CI</a>
            </li>
                
      <li>
  
                          <a href="https://sonarcloud.io/organizations/jdbdt/projects" class="externalLink" title="SonarCloud">
          <span class="none"></span>
        SonarCloud</a>
            </li>
                
      <li>
  
                          <a href="https://scan.coverity.com/projects/edrdo-jdbdt" class="externalLink" title="Coverity">
          <span class="none"></span>
        Coverity</a>
            </li>
                
      <li>
  
                          <a href="project-info.html" title="Maven reports">
          <span class="none"></span>
        Maven reports</a>
            </li>
                
      <li>
  
                          <a href="Inception.html" title="Inception">
          <span class="none"></span>
        Inception</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Database setup</h1>
<p>The contents of a database may be defined using setup methods in the <tt>JDBDT</tt> facade. The functionality at stake comprises: </p>

<ul>
  
<li>
<p>the use of <a href="DataSets.html">data sets</a> to <a href="DBSetup.html#Populate">populate a table</a> but also for table row <a href="DBSetup.html#IUD">insertions / updates / deletions</a>;</p></li>
  
<li>
<p><a href="DBSetup.html#Clean">cleaning up database tables</a>;</p></li>
  
<li>
<p>and <a href="DBSetup.html#SaveAndRestore">setting and restoring save-points</a>.</p></li>
</ul>
<p>These functionalities are described below, along with a discussion of a few <a href="DBSetup.html#Patterns">database setup patterns</a> that can be implemented using these operations.</p>
<p><a name="Populate"></a></p>
<div class="section">
<h2><a name="Populating_a_table"></a>Populating a table</h2>
<p>The <tt>populate</tt> method may be used to populate a database table. Taking a data set for a table as argument, it first clears the table at stake, then inserts the data set into the table. The supplied data set also sets a snapshot for <a href="DBAssert.html#DeltaAssertions">subsequent delta assertions</a>.</p>
<p><i>Illustration</i></p>

<div class="source">
<div class="source"><pre class="prettyprint">import static org.jdbdt.JDBDT.*;
import org.jdbdt.DB;
import org.jdbdt.Table;
import org.jdbdt.DataSet;
...
DB db = ... 
Table t = ...   

// Create a data set for t.
DataSet initialData = data(t) ... 
               // or ... builder(t) for instance

populate(initialData); 
</pre></div></div>
<p>The <tt>populateIfChanged</tt> method is a variant of <tt>populate</tt> that executes conditionally, i.e., if the table contents are seen as unchanged, no operation takes place. This only happens if an <tt>assertUnchanged</tt> <a href="DBAssertions.html">assertion</a> previously succeeded, and no intervening subsequent JDBDT setup or assertion methods were called for the table. </p>
<p><i>Illustration</i> </p>

<div class="source">
<div class="source"><pre class="prettyprint">static Table theTable ;
static DataSet initialStata; 

@BeforeClass
public static void globalSetup() {
  theTable = ... ;
  initialData = data(theTable) ...
}

@Before
public void perTestSetup() {
   populateIfChanged(initialData);
}

@Test
public void test1() {
  theSUT.methodThatShouldNotChangeAnythin();
  assertUnchanged(theTable);
  // populateIfChanged will do nothing if the assertion succeeds
}

@Test
public void test1() {
  theSUT.methodThatPerformsChanges();
  assertXXX(...); // any other assertion method
  // populateIfChanged will repopulate the table again,
  // regardless of whether the assertion succeeds or not
}
</pre></div></div>
<p>More generally, you may query the changed status of data sources using the <tt>changed</tt> facade method, and use it to guide database setup if convenient.</p>
<p><i>Illustration</i> </p>

<div class="source">
<div class="source"><pre class="prettyprint">@Before
public void perTestSetup() {
   if (changed(theTable)) {
     populate(initialData); // re-populate
     ...   // other necessary setup actions
   }
}
</pre></div></div>
<p><a name="IUD"></a></p></div>
<div class="section">
<h2><a name="Data_set_insertions_updates_and_deletes"></a>Data set insertions, updates and deletes</h2>
<p>Beyond <tt>populate</tt>, data sets may be used for table insertions, updates and deletes.</p>
<p>The <tt>insert</tt> method inserts a given data set onto a table, without deleting any previous contents (unlike <tt>populate</tt> that clears the table first). </p>

<div class="source">
<div class="source"><pre class="prettyprint">Table t = ...   
DataSet additionalData = data(t) ... 
insert(additionalData);
</pre></div></div>
<p><a name="DataSetUpdate"></a> <a name="DataSetDelete"></a></p>
<p>The <tt>update</tt> and <tt>delete</tt> method respectively update and delete a data set in the database. They require that <a href="DataSources.html#Table">key columns</a> are defined for the table at stake. The corresponding key values for each data set element will determine which rows are to be updated / deleted.</p>

<div class="source">
<div class="source"><pre class="prettyprint">DB db = ...; 
Table t = table(&quot;MyTable&quot;)
         .columns( ... )
         .key( ... )
         .build(db);    
DataSet ds = ... 

// Update
update(ds);  

// Delete
delete(ds);
</pre></div></div>
<p><a name="Clean"></a></p></div>
<div class="section">
<h2><a name="Cleaning_a_table"></a>Cleaning a table</h2>
<p>Database data may be cleaned up using one of the following methods for a <tt>Table</tt> instance <tt>t</tt>:</p>

<ol style="list-style-type: decimal">
  
<li><tt>deleteAll(t)</tt> clears the entire contents of table <tt>t</tt> using a <tt>DELETE</tt> statement without an associated <tt>WHERE</tt> clause.</li>
  
<li><tt>deleteAllWhere(t, whereClause, [,args])</tt> clears the contents of <tt>t</tt> using a <tt>DELETE</tt> statement with the specified <tt>WHERE</tt> clause (<tt>whereClause</tt>) and optional <tt>WHERE</tt> clause arguments <tt>args</tt>.</li>
  
<li><tt>truncate(t)</tt> clears <tt>t</tt> using a <tt>TRUNCATE TABLE</tt> statement.</li>
  
<li><tt>drop(t)</tt> or <tt>drop(db, tableName)</tt> drops a table entirely.</li>
</ol>
<p><i>Note</i>: <tt>truncate</tt> may be faster than <tt>deleteAll</tt>, but the associated TRUNCATE TABLE statement may not respect integrity constraints and has variable semantics for different database engines (e.g., <a class="externalLink" href="https://en.wikipedia.org/wiki/Truncate_(SQL)">see here</a>). Some engines do not support table truncation altogether (for instance SQLite).</p>
<p><i>Illustration</i></p>

<div class="source">
<div class="source"><pre class="prettyprint">import static org.jdbdt.JDBDT.*;
import org.jdbdt.DB;
import org.jdbdt.Table;
...
DB db = ...;
Table t = table(&quot;USERS&quot;)
         .columns(&quot;ID&quot;, &quot;LOGIN&quot;, &quot;NAME&quot;, &quot;PASSWORD&quot;, &quot;CREATED&quot;)
         .build(db);
...
// 1. Clear table using a DELETE statement.
deleteAll(t);

// 2. Delete all users whose login matches a certain filter
String loginFilter = ...;
deleteAll(t, &quot;LOGIN LIKE ?&quot;, loginFilter);

// 3. Clear table using TRUNCATE.
truncate(t);

// 4. Drop the table entirely.
drop(t);   // alternatively: drop(db, &quot;USERS&quot;)
</pre></div></div>
<p><a name="SaveAndRestore"></a></p></div>
<div class="section">
<h2><a name="Saving_and_restoring_database_state"></a>Saving and restoring database state</h2>
<p>Database state may be saved and restored as follows per <a href="DB.html">database handle</a> <tt>db</tt>:</p>

<ol style="list-style-type: decimal">
  
<li>A call to <tt>save(db)</tt> sets a database save-point. Internally, the save-point is set <tt>java.sql.Connection.setSavepoint()</tt> for the underlying database connection, which must have auto-commit disabled.</li>
  
<li>A call to <tt>restore(db)</tt> restores (rolls back) the database state to the JDBDT save-point defined using the last call to <tt>save(db)</tt>, as long as there were no intervening database commits.</li>
</ol>
<p>Note that that an unique one save-point is maintained per database handle, and that there should be exactly one <tt>restore</tt> call per each <tt>save</tt> call. These constraints try to ensure portable behavior across database engines.</p>
<p>In relation to <tt>save</tt> and <tt>restore</tt>, <tt>commit(db)</tt> is a shorthand for <tt>db.getConnection().commit()</tt>. Such a call commits all database changes and discards the JDBDT save-point (or any other save-point set for the database otherwise, e.g., by the SUT itself).</p>
<p><i>Illustration</i></p>

<div class="source">
<div class="source"><pre class="prettyprint">import static org.jdbdt.JDBDT.*;
import java.sql.Connection;
import org.jdbdt.DB;
...
// Database handle ...
DB db = database(...);
// Disable auto-commit
db.getConnection().setAutoCommit(false);

// Set save-point
save(db);

// Exercise the SUT, then execute some assertions  
letTheSUTWork();
assertXXX();

// Restore database state
restore(db);
</pre></div></div>
<p><a name="Patterns"></a></p></div>
<div class="section">
<h2><a name="Database_setup_patterns"></a>Database setup patterns</h2>
<p>A number of database test patterns can be implemented using JDBDT, as exemplified in the <a href="Tutorial.html">JDBDT tutorial</a>. The code skeleton below (assuming <a class="externalLink" href="http://junit.org">JUnit</a>-based tests) illustrates the implementation of two patterns described in <a class="externalLink" href="http://xunitpatterns.com">xunitpatterns.com</a>:</p>

<ol style="list-style-type: decimal">
  
<li><a class="externalLink" href="http://xunitpatterns.com/Transaction%20Rollback%20Teardown.html">Transaction Rollback Teardown</a>: changes to the database are rolled back at the end of each test, back to an initial configuration. In the illustration below, the reference database state is set once in <tt>oneTimeSetup</tt> (annotated with <tt>@BeforeClass</tt>). This state is respectively saved and restored, before and after each test executes, in <tt>setSavePoint</tt> (annotated with <tt>@Before</tt>) and <tt>restoreSavePoint</tt> (annotated with <tt>@After</tt>).</li>
  
<li><a class="externalLink" href="http://xunitpatterns.com/Table%20Truncation%20Teardown.html">Table Truncation Teardown</a>: clean up each table on tear-down after conducting tests, as shown for <tt>oneTimeTeardown</tt> (annotated with <tt>@AfterClass</tt>).</li>
</ol>
<p><i>Illustration</i> </p>

<div class="source">
<div class="source"><pre class="prettyprint">import java.sql.Connection;
import org.junit.BeforeClass;
import org.junit.AfterClass;
import org.junit.Before;
import org.junit.After;
import org.junit.Test;

import static org.jdbdt.JDBDT.*;
import org.jdbdt.DB;
import org.jdbdt.DataSet;
import org.jdbdt.Table;

public class MyTest {

  static DB myDB;
  static Table myTable1, myTable2, ... ;

  @BeforeClass 
  public static void oneTimeSetup() {
    ...
    // Setup database handle
    myDB = database( ... );

    // Define tables and corresponding initial data
    myTable1 = table(...) ... 
    DataSet initialData1 = data(myTable1). ... ;
    populate(initialData1);

    // etc for myTable2 ...
    myTable2 = table(...) ...;
    ...

    // Ensure that auto-commit is off
    myDB.getConnection().setAutoCommit(false);
  }

  @AfterClass
  public void oneTimeTeardown() {
    // Alternatively use deleteAll ...
    truncate(myTable1);
    truncate(myTable2);
    ...
    teardown(myDB, true); // free resources and close DB connection 
  }

  @Before
  public void setSavePoint() {
    save(myDB);
  }

  @After
  public void restoreSavePoint() {
    restore(myDB);
  }

  @Test 
  public void test1() {
    // Specific setup for test
    ...
    // Exercise the SUT, perform assertions
    ...
  }

  @Test 
  public void test2() { ... etc ... } 
  ...
</pre></div></div></div>
<div class="section">
<h2><a name="Summary_of_methods"></a>Summary of methods</h2>
<p><a name="MethodReference"></a></p>
<div class="section">
<h3><a name="JDBDT"></a><tt>JDBDT</tt></h3>
<p>Operations using a data set <tt>data</tt> defined for a table <tt>t</tt> (<tt>t</tt> should correspond to <tt>data.getSource()</tt>):</p>

<ul>
  
<li><tt>populate(data)</tt> sets <tt>data</tt> as the contents of a <tt>t</tt>.</li>
  
<li><tt>populateIfChanged(data)</tt> sets <tt>data</tt> as the contents of <tt>t</tt>, if <tt>t</tt> is perceived as having changed.</li>
  
<li><tt>insert(data)</tt> inserts <tt>data</tt> into <tt>t</tt>.</li>
  
<li><tt>delete(data)</tt> deletes <tt>data</tt> from <tt>t</tt>.</li>
  
<li><tt>update(data)</tt> uses <tt>data</tt> to update <tt>t</tt>.</li>
</ul>
<p>Clean-up:</p>

<ul>
  
<li><tt>delete(t)</tt> clear table <tt>t</tt> with a DELETE statement.</li>
  
<li><tt>deleteAll(t,w,a)</tt> deletes data from table <tt>t</tt> subject to WHERE clause <tt>w</tt> and optional WHERE clause arguments.</li>
  
<li><tt>truncate(t)</tt> clear table <tt>t</tt> with a TRUNCATE TABLE statement.</li>
</ul>
<p>Save and restore:</p>

<ul>
  
<li><tt>save(db)</tt> sets the JDBDT save-point;</li>
  
<li><tt>restore(db)</tt> restores database state back to the JDBDT save-point;</li>
  
<li><tt>commit(db)</tt> performs a database commit, discarding the JDBDT save-point (or any other save-point set);</li>
</ul></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2016&#x2013;2018
                        <a href="http://jdbdt.org">JDBDT</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
